# コード分析: 現在の処理とデッドコード

## 🔍 現在サポートされている文書タイプ

### lib/zip-to-pdf.ts

| 文書タイプ | ファイル番号 | 処理方法 | 実装状況 |
|-----------|------------|---------|---------|
| 表紙 (kagami) | kagami.xml | 単一PDF | ✅ 実装済み |
| 資格取得 | 7100001 | 個別PDF (1人1PDF) | ✅ 実装済み |
| 標準報酬決定 | 7130001 | 個別PDF (1人1PDF) | ✅ 実装済み |
| 標準報酬改定 | 7140001 | 統合PDF (改定年月ごと) | ✅ 実装済み |
| 70歳以上被用者 | 7200001 | 個別PDF (1人1PDF) | ✅ 実装済み |
| 70歳以上月額改定 | 7210001 | 統合PDF (改定年月ごと) | ✅ 実装済み |
| 返戻通知 (henrei) | henrei.xml | 統合PDF | ✅ 実装済み |
| **算定基礎届** | **7150001** | **❌ 未実装** | **❌ 処理ロジックなし** |
| **賞与支払届** | **7160001** | **❌ 未実装** | **❌ 処理ロジックなし** |

---

## ❌ 現在の問題

### 1. **kagami除外リストに 7150001/7160001 が含まれていない**

**場所**: `lib/zip-to-pdf.ts:41`

```typescript
const kagamiXml = Object.keys(files).find(
  (f) => !f.includes("7100001") && !f.includes("7130001") &&
         !f.includes("7140001") && !f.includes("7200001") &&
         !f.includes("7210001") && !f.includes("henrei") &&
         f.endsWith(".xml")
  // ❌ 7150001 と 7160001 が抜けている！
);
```

**問題**: 7150001.xml や 7160001.xml が kagami（表紙）として誤検出される

**修正必要**: 除外リストに追加
```typescript
!f.includes("7150001") && !f.includes("7160001") &&
```

---

### 2. **7150001/7160001 の処理ロジックが存在しない**

現在のコード構造:
```
行77-108:  7100001の処理 ✅
行110-140: 7130001の処理 ✅
行143-178: 7140001の処理 ✅
行181-211: 7200001の処理 ✅
行214-249: 7210001の処理 ✅
行252-315: henreiの処理  ✅

7150001の処理 ❌ 存在しない
7160001の処理 ❌ 存在しない
```

---

## 🗑️ デッドコード (使われていないコード)

### 1. **lib/xsl-adjuster.ts:84**

```typescript
export function adjustFontSizes(xslContent: string, scaleFactor = 1.2): string {
  // ❌ どこからも呼ばれていない
}
```

**削除推奨**: このfunction全体（84-97行）

---

### 2. **lib/document-names.ts: 7150001/7160001のマッピング未定義**

```typescript
export const DOCUMENT_NAMES: { [key: string]: string } = {
  "7100001": "健康保険・厚生年金保険資格取得確認および標準報酬決定通知書",
  "7130001": "健康保険・厚生年金保険被保険者標準報酬決定通知書",
  "7140001": "健康保険・厚生年金保険標準報酬改定通知書",
  // ❌ 7150001 がない
  // ❌ 7160001 がない
  "7200001": "厚生年金保険70歳以上被用者標準報酬月額相当額決定のお知らせ",
  "7210001": "厚生年金保険70歳以上被用者標準報酬月額相当額改定のお知らせ",
  "henrei": "返戻のお知らせ",
  "kagami": "日本年金機構からのお知らせ",
};
```

**追加推奨**:
```typescript
"7150001": "健康保険・厚生年金保険被保険者報酬月額算定基礎届",
"7160001": "健康保険・厚生年金保険標準賞与額決定通知書",
```

---

### 3. **lib/xml-info-extractor.ts: 同様に未定義**

行59-60にも7150001/7160001のマッピングが必要（現在は短縮名か未定義）

---

## 📋 推奨される対応

### ステップ1: デッドコード削除

```bash
# lib/xsl-adjuster.ts の adjustFontSizes 関数を削除
# 行84-97を削除
```

### ステップ2: kagami除外リスト修正

```typescript
// lib/zip-to-pdf.ts:41
const kagamiXml = Object.keys(files).find(
  (f) => !f.includes("7100001") && !f.includes("7130001") &&
         !f.includes("7140001") && !f.includes("7150001") &&
         !f.includes("7160001") && !f.includes("7200001") &&
         !f.includes("7210001") && !f.includes("henrei") &&
         f.endsWith(".xml")
);
```

### ステップ3: 7150001/7160001 サポート追加 (オプション)

現時点でこれらの文書をサポートしたい場合:

1. `lib/xml-parser.ts` にパーサー追加
2. `lib/zip-to-pdf.ts` に処理ロジック追加
3. `lib/document-names.ts` にマッピング追加
4. `lib/xml-info-extractor.ts` にマッピング追加

---

## 📊 処理フロー (現在)

```
ZIPアップロード
    ↓
ファイル抽出
    ↓
┌─────────────────────┐
│ kagami検出          │
│ (表紙) 41行目       │ → kagamiとして処理
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 7100001検出 77行目  │ → 個別PDF生成
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 7130001検出 110行目 │ → 個別PDF生成
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 7140001検出 143行目 │ → 統合PDF生成
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 7200001検出 181行目 │ → 個別PDF生成
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 7210001検出 214行目 │ → 統合PDF生成
└─────────────────────┘
    ↓
┌─────────────────────┐
│ henrei検出 252行目  │ → 統合PDF生成
└─────────────────────┘
    ↓
PDF + 元ファイルをZIPに圧縮
    ↓
ダウンロード
```

---

## ⚠️ 注意事項

- **7150001と7160001は現在処理されない**
  - kagami除外リストにないため、表紙として誤検出される
  - XSLが見つからず、PDFが生成されない
  - 元のXML/XSLファイルがそのまま出力ZIPに含まれるだけ

- **procedure-detector.ts では定義されている**
  - N7150001: '算定基礎届'
  - N7160001: '賞与'
  - しかし、zip-to-pdf.tsで実際の処理がない

---

## 🎯 最小限の修正

**今すぐやるべきこと（必須）**:

1. ❌ **デッドコード削除**: `lib/xsl-adjuster.ts` の `adjustFontSizes` 関数
2. ✅ **kagami除外リスト修正**: 7150001/7160001 を追加

**後でやること（オプション）**:

- 7150001/7160001の完全サポート実装

